–û—Ç–ª–∏—á–Ω–æ! –¢–µ–ø–µ—Ä—å —Å–æ–∑–¥–∞–º –ø–æ–ª–Ω—ã–π –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π –ø–ª–∞–Ω —Å —É—á—ë—Ç–æ–º –≤—Å–µ—Ö —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π.

# –ü–ª–∞–Ω —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ Product Photoshoot Bot v2.0

## –û–±–Ω–æ–≤–ª—ë–Ω–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å NanoBanana –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º —Å—Ç–∏–ª—è–º–∏

### –ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

1. **–ï–¥–∏–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ 4 —Å—Ç–∏–ª–µ–π** - —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π JSON –æ—Ç–≤–µ—Ç
2. **–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –≤—ã–±–æ—Ä–∞ –ø—Ä–æ–ø–æ—Ä—Ü–∏–π –∏ —Å—Ç–∏–ª–µ–π** - —á–µ—Ä–µ–∑ inline –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
3. **–°–ª—É—á–∞–π–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏—è** - –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω—ã—Ö —Å—Ç–∏–ª–µ–π
4. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è NanoBanana API** - –≤–º–µ—Å—Ç–æ OpenRouter –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
5. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Å—Ç–∏–ª–µ–π** - –¥–æ 4 —Å—Ç–∏–ª–µ–π —Å –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏
6. **FSM (Finite State Machine)** - –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–Ω–æ–≥–æ—à–∞–≥–æ–≤—ã–º –ø—Ä–æ—Ü–µ—Å—Å–æ–º

***

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞ (–æ–±–Ω–æ–≤–ª—ë–Ω–Ω–∞—è)

```
product-photoshoot-bot/
‚îú‚îÄ‚îÄ bot.py
‚îú‚îÄ‚îÄ alembic/
‚îÇ   ‚îî‚îÄ‚îÄ versions/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ bot.py
‚îÇ   ‚îú‚îÄ‚îÄ config.py                    # ‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å + –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å
‚îÇ   ‚îú‚îÄ‚îÄ database/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py              # ‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ models.py                # üîÑ –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å + –î–û–ë–ê–í–ò–¢–¨ StylePreset
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ crud.py                  # üîÑ –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å + –î–û–ë–ê–í–ò–¢–¨ CRUD –¥–ª—è —Å—Ç–∏–ª–µ–π
‚îÇ   ‚îú‚îÄ‚îÄ handlers/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py              # üîÑ –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ user.py                  # üîÑ –°–£–©–ï–°–¢–í–ï–ù–ù–ê–Ø –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ style_management.py      # ‚≠ê –ù–û–í–´–ô —Ñ–∞–π–ª
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ admin.py                 # ‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å + —Ç–µ–∫—Å—Ç—ã
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ payment.py               # ‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å + —Ç–µ–∫—Å—Ç—ã
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ support.py               # ‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å + —Ç–µ–∫—Å—Ç—ã
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ batch_processing.py      # üîÑ –ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ common.py                # ‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å
‚îÇ   ‚îú‚îÄ‚îÄ keyboards/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ inline.py                # üîÑ –î–û–ë–ê–í–ò–¢–¨ –Ω–æ–≤—ã–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ reply.py                 # ‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å
‚îÇ   ‚îú‚îÄ‚îÄ middlewares/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py              # ‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ db.py                    # ‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å
‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ prompt_generator.py      # ‚≠ê –ù–û–í–´–ô - –µ–¥–∏–Ω—ã–π JSON –ø—Ä–æ–º–ø—Ç
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ nanobanana.py            # ‚≠ê –ù–û–í–´–ô - API NanoBanana
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ image_processor.py       # üîÑ –ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∞—Ç—å –ø–æ–¥ –Ω–æ–≤—ã–π —Ñ–ª–æ—É
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ style_manager.py         # ‚≠ê –ù–û–í–´–ô - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∏–ª—è–º–∏
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ yookassa.py              # ‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ notification_service.py  # ‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å + —Ç–µ–∫—Å—Ç—ã
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ payment_checker.py       # ‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ yandex_metrika.py        # ‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å
‚îÇ   ‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ helpers.py               # ‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å
‚îÇ   ‚îî‚îÄ‚îÄ states.py                    # ‚≠ê –ù–û–í–´–ô - FSM —Å–æ—Å—Ç–æ—è–Ω–∏—è
‚îú‚îÄ‚îÄ requirements.txt                 # üîÑ –î–û–ë–ê–í–ò–¢–¨ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îú‚îÄ‚îÄ Dockerfile                       # ‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å
‚îú‚îÄ‚îÄ docker-compose.yml               # ‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å + –∏–º–µ–Ω–∞
‚îú‚îÄ‚îÄ .env.example                     # üîÑ –î–û–ë–ê–í–ò–¢–¨ –Ω–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
‚îî‚îÄ‚îÄ README.md                        # üîÑ –ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å
```

***

## –î–µ—Ç–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω —Ñ–∞–π–ª–æ–≤

### 1. Config (`app/config.py`)

**–ò—Å—Ç–æ—á–Ω–∏–∫:** [photo-portrait-bot/app/config.py](https://github.com/f2re/photo-portrait-bot/blob/main/app/config.py)

**–ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏:**

```python
from pydantic_settings import BaseSettings
from typing import List, Optional

class Settings(BaseSettings):
    # Telegram
    BOT_TOKEN: str
    BOT_USERNAME: str
    ADMIN_IDS: str
    
    # Database
    DATABASE_URL: Optional[str] = None
    DB_HOST: str = "localhost"
    DB_PORT: int = 5432
    DB_NAME: str = "product_photoshoot_bot"
    DB_USER: str = "product_user"
    DB_PASSWORD: str = ""
    
    # ‚≠ê –ù–û–í–û–ï: OpenRouter –¥–ª—è –ø—Ä–æ–º–ø—Ç–æ–≤ (Claude)
    OPENROUTER_API_KEY: str
    PROMPT_MODEL: str = "anthropic/claude-3.5-sonnet"  # –î–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Ä–æ–º–ø—Ç–æ–≤
    
    # YooKassa
    YOOKASSA_SHOP_ID: str
    YOOKASSA_SECRET_KEY: str
    YOOKASSA_RETURN_URL: str = "https://t.me/your_product_bot"
    
    # ‚≠ê –ù–û–í–û–ï: –ü–∞–∫–µ—Ç—ã (–∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥ —Ç–æ–≤–∞—Ä–Ω—É—é —Å—ä–µ–º–∫—É)
    PACKAGE_1_NAME: str = "–°—Ç–∞—Ä—Ç–æ–≤—ã–π"
    PACKAGE_1_PHOTOSHOOTS: int = 3  # —Ñ–æ—Ç–æ—Å–µ—Å—Å–∏–π (–∫–∞–∂–¥–∞—è = 4 —Ñ–æ—Ç–æ)
    PACKAGE_1_PRICE: int = 299
    
    PACKAGE_2_NAME: str = "–ë–∏–∑–Ω–µ—Å"
    PACKAGE_2_PHOTOSHOOTS: int = 10
    PACKAGE_2_PRICE: int = 799
    
    PACKAGE_3_NAME: str = "–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π"
    PACKAGE_3_PHOTOSHOOTS: int = 30
    PACKAGE_3_PRICE: int = 1999
    
    PACKAGE_4_NAME: str = "–ë–µ–∑–ª–∏–º–∏—Ç–Ω—ã–π"
    PACKAGE_4_PHOTOSHOOTS: int = 100
    PACKAGE_4_PRICE: int = 4999
    
    # ‚≠ê –ù–û–í–û–ï: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ñ–æ—Ç–æ—Å–µ—Å—Å–∏–π
    FREE_PHOTOSHOOTS_COUNT: int = 2  # –ë–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö —Ñ–æ—Ç–æ—Å–µ—Å—Å–∏–π –¥–ª—è –Ω–æ–≤—ã—Ö
    PHOTOS_PER_PHOTOSHOOT: int = 4  # –§–æ—Ç–æ –≤ –æ–¥–Ω–æ–π —Ñ–æ—Ç–æ—Å–µ—Å—Å–∏–∏
    MAX_SAVED_STYLES: int = 4  # –ú–∞–∫—Å–∏–º—É–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —Å—Ç–∏–ª–µ–π
    
    # ‚≠ê –ù–û–í–û–ï: –î–æ—Å—Ç—É–ø–Ω—ã–µ –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏
    AVAILABLE_ASPECT_RATIOS: List[str] = [
        "1:1",    # –ö–≤–∞–¥—Ä–∞—Ç (Instagram)
        "3:4",    # –í–µ—Ä—Ç–∏–∫–∞–ª—å (Stories)
        "4:3",    # –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å
        "16:9",   # –®–∏—Ä–æ–∫–∏–π (YouTube)
        "9:16"    # –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π (TikTok)
    ]
    
    # Logging
    LOG_LEVEL: str = "INFO"
    
    # Yandex Metrika (optional)
    YANDEX_METRIKA_COUNTER_ID: Optional[str] = None
    YANDEX_METRIKA_TOKEN: Optional[str] = None
    METRIKA_GOAL_START: str = "start_bot"
    METRIKA_GOAL_FIRST_PHOTOSHOOT: str = "first_photoshoot"
    METRIKA_GOAL_PURCHASE: str = "purchase"
    METRIKA_UPLOAD_INTERVAL: int = 3600
    
    # Referral Program
    REFERRAL_REWARD_START: int = 1  # —Ñ–æ—Ç–æ—Å–µ—Å—Å–∏–π –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Ä–µ—Ñ–µ—Ä–∞–ª–∞
    REFERRAL_REWARD_PURCHASE_PERCENT: int = 10
    
    class Config:
        env_file = ".env"
        env_file_encoding = "utf-8"
    
    @property
    def database_url(self) -> str:
        if self.DATABASE_URL:
            return self.DATABASE_URL
        return f"postgresql+asyncpg://{self.DB_USER}:{self.DB_PASSWORD}@{self.DB_HOST}:{self.DB_PORT}/{self.DB_NAME}"
    
    @property
    def admin_ids_list(self) -> List[int]:
        return [int(id.strip()) for id in self.ADMIN_IDS.split(",") if id.strip()]
    
    @property
    def packages_config(self) -> List[dict]:
        """–ü–∞–∫–µ—Ç—ã —Ñ–æ—Ç–æ—Å–µ—Å—Å–∏–π"""
        return [
            {
                "name": self.PACKAGE_1_NAME,
                "photoshoots_count": self.PACKAGE_1_PHOTOSHOOTS,
                "price_rub": self.PACKAGE_1_PRICE
            },
            {
                "name": self.PACKAGE_2_NAME,
                "photoshoots_count": self.PACKAGE_2_PHOTOSHOOTS,
                "price_rub": self.PACKAGE_2_PRICE
            },
            {
                "name": self.PACKAGE_3_NAME,
                "photoshoots_count": self.PACKAGE_3_PHOTOSHOOTS,
                "price_rub": self.PACKAGE_3_PRICE
            },
            {
                "name": self.PACKAGE_4_NAME,
                "photoshoots_count": self.PACKAGE_4_PHOTOSHOOTS,
                "price_rub": self.PACKAGE_4_PRICE
            }
        ]
    
    @property
    def is_metrika_enabled(self) -> bool:
        return bool(self.YANDEX_METRIKA_COUNTER_ID and self.YANDEX_METRIKA_TOKEN)

settings = Settings()
```

***

### 2. Database Models (`app/database/models.py`)

**–ò—Å—Ç–æ—á–Ω–∏–∫:** [photo-portrait-bot/app/database/models.py](https://github.com/f2re/photo-portrait-bot/blob/main/app/database/models.py)

**–ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏:** –î–û–ë–ê–í–ò–¢–¨ –Ω–æ–≤—É—é –º–æ–¥–µ–ª—å StylePreset

```python
from sqlalchemy import Column, Integer, String, DateTime, Boolean, ForeignKey, Text, JSON
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from sqlalchemy.ext.declarative import declarative_base

Base = declarative_base()

# ‚úÖ User - —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∏–∑ –∏—Å—Ö–æ–¥–Ω–∏–∫–∞ –ë–ï–ó –∏–∑–º–µ–Ω–µ–Ω–∏–π
class User(Base):
    __tablename__ = "users"
    # ... (–≤–µ—Å—å –∫–æ–¥ –∏–∑ photo-portrait-bot/app/database/models.py)

# ‚úÖ Payment - —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∏–∑ –∏—Å—Ö–æ–¥–Ω–∏–∫–∞ –ë–ï–ó –∏–∑–º–µ–Ω–µ–Ω–∏–π
class Payment(Base):
    __tablename__ = "payments"
    # ... (–≤–µ—Å—å –∫–æ–¥ –∏–∑ photo-portrait-bot)

# üîÑ ProcessedImage - –ú–û–î–ò–§–ò–¶–ò–†–û–í–ê–¢–¨: –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—è
class ProcessedImage(Base):
    __tablename__ = "processed_images"
    
    id = Column(Integer, primary_key=True, index=True)
    user_id = Column(Integer, ForeignKey("users.id"), nullable=False)
    telegram_file_id = Column(String, nullable=True)
    
    # ‚≠ê –ù–û–í–û–ï: –¥–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å—Ç–∏–ª–µ
    style_name = Column(String, nullable=True)  # –ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ç–∏–ª—è
    prompt_used = Column(Text, nullable=True)   # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç
    aspect_ratio = Column(String, nullable=True) # –ü—Ä–æ–ø–æ—Ä—Ü–∏–∏ (1:1, 3:4 –∏ —Ç.–¥.)
    
    processed_at = Column(DateTime(timezone=True), server_default=func.now())
    
    # Relationship
    user = relationship("User", back_populates="processed_images")

# ‚≠ê –ù–û–í–ê–Ø –ú–û–î–ï–õ–¨: StylePreset
class StylePreset(Base):
    """–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Å—Ç–∏–ª–∏"""
    __tablename__ = "style_presets"
    
    id = Column(Integer, primary_key=True, index=True)
    user_id = Column(Integer, ForeignKey("users.id"), nullable=False)
    
    # –ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ç–∏–ª—è (–∑–∞–¥–∞—ë—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)
    name = Column(String(100), nullable=False)  # –Ω–∞–ø—Ä. "–ú–∏–Ω–∏–º–∞–ª–∏–∑–º –±–µ–ª—ã–π —Ñ–æ–Ω"
    
    # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å—Ç–∏–ª—è (JSON)
    style_data = Column(JSON, nullable=False)
    # –°—Ç—Ä—É–∫—Ç—É—Ä–∞ style_data:
    # {
    #     "product_name": "...",
    #     "aspect_ratio": "1:1",
    #     "prompts": [
    #         {"style": "...", "prompt": "..."},
    #         {"style": "...", "prompt": "..."},
    #         {"style": "...", "prompt": "..."},
    #         {"style": "...", "prompt": "..."}
    #     ]
    # }
    
    # –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
    created_at = Column(DateTime(timezone=True), server_default=func.now())
    updated_at = Column(DateTime(timezone=True), onupdate=func.now())
    is_active = Column(Boolean, default=True)
    
    # Relationship
    user = relationship("User", back_populates="style_presets")

# –û–±–Ω–æ–≤–∏—Ç—å User –º–æ–¥–µ–ª—å: –¥–æ–±–∞–≤–∏—Ç—å relationships
# –í –∫–ª–∞—Å—Å–µ User –¥–æ–±–∞–≤–∏—Ç—å:
# processed_images = relationship("ProcessedImage", back_populates="user")
# style_presets = relationship("StylePreset", back_populates="user")
```

***

### 3. Database CRUD (`app/database/crud.py`)

**–ò—Å—Ç–æ—á–Ω–∏–∫:** [photo-portrait-bot/app/database/crud.py](https://github.com/f2re/photo-portrait-bot/blob/main/app/database/crud.py)

**–î–µ–π—Å—Ç–≤–∏–µ:** –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤–µ—Å—å —Ñ–∞–π–ª + –î–û–ë–ê–í–ò–¢–¨ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è StylePreset

```python
# ‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ CRUD —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑ –∏—Å—Ö–æ–¥–Ω–∏–∫–∞

# ‚≠ê –î–û–ë–ê–í–ò–¢–¨ –≤ –∫–æ–Ω–µ—Ü —Ñ–∞–π–ª–∞:

async def create_style_preset(
    session: AsyncSession,
    user_id: int,
    name: str,
    style_data: dict
) -> StylePreset:
    """–°–æ–∑–¥–∞—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π —Å—Ç–∏–ª—å"""
    preset = StylePreset(
        user_id=user_id,
        name=name,
        style_data=style_data
    )
    session.add(preset)
    await session.commit()
    await session.refresh(preset)
    return preset

async def get_user_style_presets(
    session: AsyncSession,
    user_id: int,
    active_only: bool = True
) -> List[StylePreset]:
    """–ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ —Å—Ç–∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    query = select(StylePreset).where(StylePreset.user_id == user_id)
    if active_only:
        query = query.where(StylePreset.is_active == True)
    query = query.order_by(StylePreset.created_at.desc())
    result = await session.execute(query)
    return result.scalars().all()

async def get_style_preset_by_id(
    session: AsyncSession,
    preset_id: int,
    user_id: int
) -> Optional[StylePreset]:
    """–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∏–ª—å –ø–æ ID"""
    query = select(StylePreset).where(
        StylePreset.id == preset_id,
        StylePreset.user_id == user_id,
        StylePreset.is_active == True
    )
    result = await session.execute(query)
    return result.scalar_one_or_none()

async def update_style_preset(
    session: AsyncSession,
    preset_id: int,
    user_id: int,
    name: Optional[str] = None,
    style_data: Optional[dict] = None
) -> Optional[StylePreset]:
    """–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∏–ª—å"""
    preset = await get_style_preset_by_id(session, preset_id, user_id)
    if not preset:
        return None
    
    if name:
        preset.name = name
    if style_data:
        preset.style_data = style_data
    
    await session.commit()
    await session.refresh(preset)
    return preset

async def delete_style_preset(
    session: AsyncSession,
    preset_id: int,
    user_id: int
) -> bool:
    """–£–¥–∞–ª–∏—Ç—å —Å—Ç–∏–ª—å (–º—è–≥–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ)"""
    preset = await get_style_preset_by_id(session, preset_id, user_id)
    if not preset:
        return False
    
    preset.is_active = False
    await session.commit()
    return True

async def count_user_active_presets(
    session: AsyncSession,
    user_id: int
) -> int:
    """–ü–æ–¥—Å—á–∏—Ç–∞—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    query = select(func.count(StylePreset.id)).where(
        StylePreset.user_id == user_id,
        StylePreset.is_active == True
    )
    result = await session.execute(query)
    return result.scalar() or 0
```

***

### 4. FSM States (`app/states.py`) - ‚≠ê –ù–û–í–´–ô –§–ê–ô–õ

```python
"""FSM —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –º–Ω–æ–≥–æ—à–∞–≥–æ–≤–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–æ—Ç–æ—Å–µ—Å—Å–∏–∏"""
from aiogram.fsm.state import State, StatesGroup

class PhotoshootStates(StatesGroup):
    """–°–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–æ—Ç–æ—Å–µ—Å—Å–∏–∏"""
    
    # –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ —Ç–æ–≤–∞—Ä–∞
    waiting_for_product_photo = State()
    
    # –í—ã–±–æ—Ä –ø—Ä–æ–ø–æ—Ä—Ü–∏–π
    selecting_aspect_ratio = State()
    
    # –í—ã–±–æ—Ä —Å—Ç–∏–ª–µ–π (–∞–Ω–∞–ª–∏–∑ / —Å–ª—É—á–∞–π–Ω—ã–µ / —Å–≤–æ–∏)
    selecting_styles_method = State()
    
    # –ü—Ä–æ—Å–º–æ—Ç—Ä –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã—Ö —Å—Ç–∏–ª–µ–π –∏ –≤—ã–±–æ—Ä
    reviewing_suggested_styles = State()
    
    # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ñ–æ—Ç–æ—Å–µ—Å—Å–∏–∏
    generating_photoshoot = State()
    
    # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—Ç–∏–ª—è
    saving_style_name = State()

class StyleManagementStates(StatesGroup):
    """–°–æ—Å—Ç–æ—è–Ω–∏—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—Ç–∏–ª—è–º–∏"""
    
    # –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —Å—Ç–∏–ª–µ–π
    viewing_saved_styles = State()
    
    # –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è —Å—Ç–∏–ª—è
    editing_style_name = State()
```

***

### 5. Prompt Generator (`app/services/prompt_generator.py`) - ‚≠ê –ù–û–í–´–ô

```python
"""
–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ø—Ä–æ–º–ø—Ç–æ–≤ –¥–ª—è —Ñ–æ—Ç–æ—Å–µ—Å—Å–∏–∏ —Ç–æ–≤–∞—Ä–∞
–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π JSON —Å 4 —Å—Ç–∏–ª—è–º–∏
"""
import logging
import aiohttp
import json
from typing import Dict, List, Optional
from app.config import settings

logger = logging.getLogger(__name__)

class PromptGenerator:
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç 4 –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è —Ñ–æ—Ç–æ—Å–µ—Å—Å–∏–∏ —Ç–æ–≤–∞—Ä–∞ –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–º JSON"""
    
    SYSTEM_PROMPT = """–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –≤ product photography –∏ creative direction.
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä –∏ —Å–æ–∑–¥–∞—Ç—å 4 —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã—Ö 
–ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –≤ —Ä–∞–∑–Ω—ã—Ö —Å—Ç–∏–ª—è—Ö.

–í–ê–ñ–ù–û: –û—Ç–≤–µ—Ç –î–û–õ–ñ–ï–ù –±—ã—Ç—å –≤–∞–ª–∏–¥–Ω—ã–º JSON —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã:
{
  "product_name": "–∫—Ä–∞—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ (2-4 —Å–ª–æ–≤–∞)",
  "styles": [
    {
      "style_name": "–∫—Ä–∞—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å—Ç–∏–ª—è (2-3 —Å–ª–æ–≤–∞ –Ω–∞ —Ä—É—Å—Å–∫–æ–º)",
      "prompt": "–¥–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏"
    },
    {
      "style_name": "...",
      "prompt": "..."
    },
    {
      "style_name": "...",
      "prompt": "..."
    },
    {
      "style_name": "...",
      "prompt": "..."
    }
  ]
}

4 —Å—Ç–∏–ª—è –î–û–õ–ñ–ù–´ –±—ã—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Ä–∞–∑–Ω—ã–º–∏:
1. Lifestyle / In-use (—Ç–æ–≤–∞—Ä –≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏, –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–∞—è —Å—Ä–µ–¥–∞)
2. Studio / Clean (—Å—Ç—É–¥–∏–π–Ω–∞—è —Å—ä–µ–º–∫–∞, —á–∏—Å—Ç—ã–π —Ñ–æ–Ω, –∞–∫—Ü–µ–Ω—Ç –Ω–∞ –¥–µ—Ç–∞–ª–∏)
3. Interior / Context (—Ç–æ–≤–∞—Ä –≤ –∏–Ω—Ç–µ—Ä—å–µ—Ä–µ, –∞—Ç–º–æ—Å—Ñ–µ—Ä–∞)
4. Creative / Artistic (–∫—Ä–µ–∞—Ç–∏–≤–Ω–∞—è –∫–æ–Ω—Ü–µ–ø—Ü–∏—è, —Ö—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥)

–ö–∞–∂–¥—ã–π prompt –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å:
- –û–ø–∏—Å–∞–Ω–∏–µ –∫–æ–º–ø–æ–∑–∏—Ü–∏–∏ –∏ —Ä–∞–∫—É—Ä—Å–∞
- –û—Å–≤–µ—â–µ–Ω–∏–µ (natural, studio, dramatic, soft –∏ —Ç.–¥.)
- –¶–≤–µ—Ç–æ–≤—É—é –ø–∞–ª–∏—Ç—Ä—É –∏ mood
- –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (camera, lens, aperture)
- –î–µ—Ç–∞–ª–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–ü—Ä–æ–º–ø—Ç—ã –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º –¥–ª—è –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å image generation AI."""

    RANDOM_STYLES_PROMPT = """–¢—ã - –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–π –¥–∏—Ä–µ–∫—Ç–æ—Ä –≤ product photography.
–°–æ–∑–¥–∞–π 4 –°–õ–£–ß–ê–ô–ù–´–•, –£–ù–ò–ö–ê–õ–¨–ù–´–•, –ù–ï –ü–û–•–û–ñ–ò–• –¥—Ä—É–≥ –Ω–∞ –¥—Ä—É–≥–∞ —Å—Ç–∏–ª—è –¥–ª—è —Ñ–æ—Ç–æ—Å–µ—Å—Å–∏–∏ —Ç–æ–≤–∞—Ä–∞.

–ë—É–¥—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–º! –ò—Å–ø–æ–ª—å–∑—É–π —Ä–∞–∑–Ω—ã–µ:
- –¶–≤–µ—Ç–æ–≤—ã–µ —Å—Ö–µ–º—ã (–º–æ–Ω–æ—Ö—Ä–æ–º, vibrant, pastel, dramatic)
- –†–∞–∫—É—Ä—Å—ã (top-down, 45¬∞, macro, wide shot)
- –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏—è (–º–∏–Ω–∏–º–∞–ª–∏–∑–º, luxury, industrial, organic, futuristic)
- –û—Å–≤–µ—â–µ–Ω–∏–µ (neon, golden hour, studio flash, natural window light)
- –ö–æ–Ω—Ç–µ–∫—Å—Ç—ã (urban, nature, abstract, architectural)

–í–ê–ñ–ù–û: –û—Ç–≤–µ—Ç –≤ —Ç–æ–º –∂–µ JSON —Ñ–æ—Ä–º–∞—Ç–µ:
{
  "product_name": "–∫—Ä–∞—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞",
  "styles": [
    {"style_name": "–Ω–∞–∑–≤–∞–Ω–∏–µ —Å—Ç–∏–ª—è", "prompt": "–¥–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç"},
    ...4 —Å—Ç–∏–ª—è...
  ]
}"""

    def __init__(self):
        self.api_key = settings.OPENROUTER_API_KEY
        self.model = settings.PROMPT_MODEL
        self.base_url = "https://openrouter.ai/api/v1/chat/completions"
    
    async def generate_styles_from_description(
        self,
        product_description: str,
        aspect_ratio: str = "1:1",
        random: bool = False
    ) -> Dict:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç 4 —Å—Ç–∏–ª—è –¥–ª—è —Ç–æ–≤–∞—Ä–∞
        
        Args:
            product_description: –û–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
            aspect_ratio: –ü—Ä–æ–ø–æ—Ä—Ü–∏–∏ (1:1, 3:4, –∏ —Ç.–¥.)
            random: –ï—Å–ª–∏ True - –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–ª—É—á–∞–π–Ω—ã–µ –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–µ —Å—Ç–∏–ª–∏
            
        Returns:
            {
                "success": bool,
                "product_name": str,
                "styles": [
                    {"style_name": "...", "prompt": "..."},
                    ...
                ],
                "error": Optional[str]
            }
        """
        try:
            user_prompt = f"""–¢–æ–≤–∞—Ä: {product_description}
–ü—Ä–æ–ø–æ—Ä—Ü–∏–∏ —Ñ–æ—Ç–æ: {aspect_ratio}

{"–°–æ–∑–¥–∞–π 4 –°–õ–£–ß–ê–ô–ù–´–•, –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –†–ê–ó–ù–´–• –∏ –ö–†–ï–ê–¢–ò–í–ù–´–• —Å—Ç–∏–ª—è!" if random else "–°–æ–∑–¥–∞–π 4 –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã—Ö —Å—Ç–∏–ª—è –¥–ª—è —ç—Ç–æ–≥–æ —Ç–æ–≤–∞—Ä–∞."}

–í–µ—Ä–Ω–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –°–¢–†–û–ì–û –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ."""

            headers = {
                "Authorization": f"Bearer {self.api_key}",
                "Content-Type": "application/json",
                "HTTP-Referer": "https://product-photoshoot-bot.com",
                "X-Title": "Product Photoshoot Bot"
            }
            
            payload = {
                "model": self.model,
                "messages": [
                    {
                        "role": "system",
                        "content": self.RANDOM_STYLES_PROMPT if random else self.SYSTEM_PROMPT
                    },
                    {
                        "role": "user",
                        "content": user_prompt
                    }
                ],
                "temperature": 0.9 if random else 0.7,
                "max_tokens": 2000,
                "response_format": {"type": "json_object"}  # –¢—Ä–µ–±—É–µ–º JSON
            }
            
            logger.info(f"Generating {'random' if random else 'analyzed'} styles for: {product_description[:50]}")
            
            async with aiohttp.ClientSession() as session:
                async with session.post(
                    self.base_url,
                    json=payload,
                    headers=headers,
                    timeout=aiohttp.ClientTimeout(total=60)
                ) as response:
                    if response.status == 200:
                        result = await response.json()
                        content = result['choices'][0]['message']['content']
                        
                        # –ü–∞—Ä—Å–∏–º JSON
                        try:
                            data = json.loads(content)
                            
                            # –í–∞–ª–∏–¥–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
                            if not self._validate_response(data):
                                raise ValueError("Invalid JSON structure")
                            
                            logger.info(f"Successfully generated styles for: {data.get('product_name', 'unknown')}")
                            
                            return {
                                "success": True,
                                "product_name": data["product_name"],
                                "styles": data["styles"],
                                "error": None
                            }
                            
                        except json.JSONDecodeError as e:
                            logger.error(f"Failed to parse JSON response: {e}")
                            logger.debug(f"Response content: {content}")
                            return self._fallback_response(product_description, aspect_ratio)
                    
                    else:
                        error_text = await response.text()
                        logger.error(f"API error: {response.status} - {error_text}")
                        return self._fallback_response(product_description, aspect_ratio)
                        
        except Exception as e:
            logger.error(f"Error generating styles: {e}", exc_info=True)
            return self._fallback_response(product_description, aspect_ratio)
    
    def _validate_response(self, data: dict) -> bool:
        """–í–∞–ª–∏–¥–∞—Ü–∏—è JSON —Å—Ç—Ä—É–∫—Ç—É—Ä—ã"""
        if not isinstance(data, dict):
            return False
        
        if "product_name" not in data or "styles" not in data:
            return False
        
        if not isinstance(data["styles"], list) or len(data["styles"]) != 4:
            return False
        
        for style in data["styles"]:
            if not isinstance(style, dict):
                return False
            if "style_name" not in style or "prompt" not in style:
                return False
        
        return True
    
    def _fallback_response(self, product: str, aspect_ratio: str) -> Dict:
        """Fallback –µ—Å–ª–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å"""
        logger.warning("Using fallback prompts")
        
        return {
            "success": True,
            "product_name": product[:30],
            "styles": [
                {
                    "style_name": "Lifestyle",
                    "prompt": f"Professional lifestyle product photography of {product}, in use by person, natural environment, warm natural lighting, candid moment, aspect ratio {aspect_ratio}, shot on Canon EOS R5, 50mm f/1.8, shallow depth of field, authentic feel, high-end commercial quality"
                },
                {
                    "style_name": "–°—Ç—É–¥–∏–π–Ω–∞—è —Å—ä–µ–º–∫–∞",
                    "prompt": f"Clean studio product shot of {product}, pure white background, professional studio lighting setup with softboxes, sharp focus on every detail, ultra high resolution 8k, aspect ratio {aspect_ratio}, Sony A7IV, 85mm f/1.4 macro, minimal shadows, e-commerce photography, product catalog quality"
                },
                {
                    "style_name": "–ò–Ω—Ç–µ—Ä—å–µ—Ä",
                    "prompt": f"{product} elegantly placed in modern minimalist interior, natural window light creating soft shadows, contemporary home setting, aspect ratio {aspect_ratio}, architectural photography style, Fujifilm GFX 100S, 35mm f/2, ambient atmosphere, lifestyle magazine quality"
                },
                {
                    "style_name": "–ö—Ä–µ–∞—Ç–∏–≤–Ω–∞—è",
                    "prompt": f"Creative conceptual photography of {product}, artistic composition with dynamic angles, vibrant color palette, dramatic studio lighting, aspect ratio {aspect_ratio}, fashion editorial style, Phase One XF, 80mm f/2.8, cinematic mood, advertising campaign quality, bold visual statement"
                }
            ],
            "error": None
        }
```

***

### 7. Style Manager (`app/services/style_manager.py`) - ‚≠ê –ù–û–í–´–ô

```python
"""
–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º–∏ —Å—Ç–∏–ª—è–º–∏
"""
import logging
from typing import List, Dict, Optional
from sqlalchemy.ext.asyncio import AsyncSession
from app.database.crud import (
    create_style_preset,
    get_user_style_presets,
    get_style_preset_by_id,
    update_style_preset,
    delete_style_preset,
    count_user_active_presets
)
from app.config import settings

logger = logging.getLogger(__name__)

class StyleManager:
    """–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–º–∏ —Å—Ç–∏–ª—è–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    
    @staticmethod
    async def save_style(
        session: AsyncSession,
        user_id: int,
        name: str,
        product_name: str,
        aspect_ratio: str,
        styles: List[Dict]
    ) -> Dict:
        """
        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–æ–≤—ã–π —Å—Ç–∏–ª—å
        
        Args:
            session: DB —Å–µ—Å—Å–∏—è
            user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            name: –ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ç–∏–ª—è (–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
            product_name: –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
            aspect_ratio: –ü—Ä–æ–ø–æ—Ä—Ü–∏–∏
            styles: –°–ø–∏—Å–æ–∫ –∏–∑ 4 —Å—Ç–∏–ª–µ–π [{"style_name": "...", "prompt": "..."}, ...]
            
        Returns:
            {"success": bool, "preset_id": int, "error": Optional[str]}
        """
        try:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç
            count = await count_user_active_presets(session, user_id)
            if count >= settings.MAX_SAVED_STYLES:
                return {
                    "success": False,
                    "preset_id": None,
                    "error": f"–î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —Å—Ç–∏–ª–µ–π ({settings.MAX_SAVED_STYLES})"
                }
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ —Å—Ç–∏–ª—è
            style_data = {
                "product_name": product_name,
                "aspect_ratio": aspect_ratio,
                "prompts": styles
            }
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º
            preset = await create_style_preset(
                session=session,
                user_id=user_id,
                name=name,
                style_data=style_data
            )
            
            logger.info(f"Saved new style preset '{name}' for user {user_id}")
            
            return {
                "success": True,
                "preset_id": preset.id,
                "error": None
            }
            
        except Exception as e:
            logger.error(f"Error saving style: {e}", exc_info=True)
            return {
                "success": False,
                "preset_id": None,
                "error": str(e)
            }
    
    @staticmethod
    async def get_user_styles(
        session: AsyncSession,
        user_id: int
    ) -> List[Dict]:
        """
        –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ —Å—Ç–∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        
        Returns:
            [{"id": int, "name": str, "product_name": str, "aspect_ratio": str, "created_at": datetime}, ...]
        """
        try:
            presets = await get_user_style_presets(session, user_id)
            
            return [
                {
                    "id": preset.id,
                    "name": preset.name,
                    "product_name": preset.style_data.get("product_name", "Unknown"),
                    "aspect_ratio": preset.style_data.get("aspect_ratio", "1:1"),
                    "created_at": preset.created_at
                }
                for preset in presets
            ]
            
        except Exception as e:
            logger.error(f"Error getting user styles: {e}", exc_info=True)
            return []
    
    @staticmethod
    async def apply_style(
        session: AsyncSession,
        user_id: int,
        preset_id: int
    ) -> Optional[Dict]:
        """
        –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π —Å—Ç–∏–ª—å
        
        Returns:
            {
                "product_name": str,
                "aspect_ratio": str,
                "styles": [{"style_name": "...", "prompt": "..."}, ...]
            }
        """
        try:
            preset = await get_style_preset_by_id(session, preset_id, user_id)
            if not preset:
                return None
            
            return {
                "product_name": preset.style_data["product_name"],
                "aspect_ratio": preset.style_data["aspect_ratio"],
                "styles": preset.style_data["prompts"]
            }
            
        except Exception as e:
            logger.error(f"Error applying style: {e}", exc_info=True)
            return None
    
    @staticmethod
    async def delete_style(
        session: AsyncSession,
        user_id: int,
        preset_id: int
    ) -> bool:
        """–£–¥–∞–ª–∏—Ç—å —Å—Ç–∏–ª—å"""
        try:
            success = await delete_style_preset(session, preset_id, user_id)
            if success:
                logger.info(f"Deleted style preset {preset_id} for user {user_id}")
            return success
            
        except Exception as e:
            logger.error(f"Error deleting style: {e}", exc_info=True)
            return False
    
    @staticmethod
    async def rename_style(
        session: AsyncSession,
        user_id: int,
        preset_id: int,
        new_name: str
    ) -> bool:
        """–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å —Å—Ç–∏–ª—å"""
        try:
            preset = await update_style_preset(
                session=session,
                preset_id=preset_id,
                user_id=user_id,
                name=new_name
            )
            
            if preset:
                logger.info(f"Renamed style preset {preset_id} to '{new_name}'")
                return True
            return False
            
        except Exception as e:
            logger.error(f"Error renaming style: {e}", exc_info=True)
            return False
```

***

### 8. Image Processor (`app/services/image_processor.py`) - üîÑ –°–£–©–ï–°–¢–í–ï–ù–ù–ê–Ø –ú–û–î–ò–§–ò–ö–ê–¶–ò–Ø

**–ò—Å—Ç–æ—á–Ω–∏–∫:** [photo-portrait-bot/app/services/image_processor.py](https://github.com/f2re/photo-portrait-bot/blob/main/app/services/image_processor.py)

**–î–µ–π—Å—Ç–≤–∏–µ:** –ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å –ª–æ–≥–∏–∫—É –ø–æ–¥ –Ω–æ–≤—ã–π —Ñ–ª–æ—É

```python
"""
–ü—Ä–æ—Ü–µ—Å—Å–æ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –¥–ª—è —Ñ–æ—Ç–æ—Å–µ—Å—Å–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤
–ö–æ–æ—Ä–¥–∏–Ω–∏—Ä—É–µ—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏—é 4 –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ —á–µ—Ä–µ–∑ NanoBanana
"""
import logging
import asyncio
from io import BytesIO
from typing import Dict, List
from PIL import Image
from aiogram import Bot

from app.database.models import User
from app.services.nanobanana import NanoBananaService
from app.services.notification_service import NotificationService

logger = logging.getLogger(__name__)

class ImageProcessor:
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è —Ñ–æ—Ç–æ—Å–µ—Å—Å–∏–∏"""
    
    def __init__(self):
        self.nanobanana = NanoBananaService()
    
    def _convert_webp_to_png(self, image_bytes: bytes) -> bytes:
        """–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è WebP –≤ PNG (–∏–∑ –∏—Å—Ö–æ–¥–Ω–∏–∫–∞ –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô)"""
        # ... (—Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∏–∑ photo-portrait-bot/app/services/image_processor.py)
        pass
    
    async def generate_photoshoot(
        self,
        product_image_bytes: bytes,
        styles: List[Dict],
        aspect_ratio: str,
        bot: Bot,
        user: User
    ) -> Dict:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ñ–æ—Ç–æ—Å–µ—Å—Å–∏—é –∏–∑ 4 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        
        Args:
            product_image_bytes: –ò—Å—Ö–æ–¥–Ω–æ–µ —Ñ–æ—Ç–æ —Ç–æ–≤–∞—Ä–∞
            styles: –°–ø–∏—Å–æ–∫ –∏–∑ 4 —Å—Ç–∏–ª–µ–π [{"style_name": "...", "prompt": "..."}, ...]
            aspect_ratio: –ü—Ä–æ–ø–æ—Ä—Ü–∏–∏ (1:1, 3:4, –∏ —Ç.–¥.)
            bot: –ë–æ—Ç –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
            user: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
            
        Returns:
            {
                "success": bool,
                "images": [
                    {
                        "success": bool,
                        "image_bytes": Optional[bytes],
                        "style_name": str,
                        "prompt": str,
                        "error": Optional[str]
                    },
                    ... (4 —à—Ç)
                ],
                "successful_count": int,
                "error": Optional[str]
            }
        """
        try:
            logger.info(f"Starting photoshoot generation for user {user.telegram_id}")
            
            # –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤—Ö–æ–¥–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            try:
                img = Image.open(BytesIO(product_image_bytes))
                width, height = img.size
                original_format = img.format
                logger.info(f"Input image: {width}x{height}, format: {original_format}")
                
                # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º WebP –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                if original_format and original_format.upper() == 'WEBP':
                    logger.info("Converting WebP to PNG...")
                    product_image_bytes = self._convert_webp_to_png(product_image_bytes)
                    
            except Exception as e:
                logger.error(f"Invalid image format: {e}")
                return {
                    "success": False,
                    "images": [],
                    "successful_count": 0,
                    "error": "–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è"
                }
            
            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º 4 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ü–ê–†–ê–õ–õ–ï–õ–¨–ù–û
            tasks = [
                self._generate_single_variant(
                    product_image_bytes,
                    style["prompt"],
                    style["style_name"],
                    aspect_ratio
                )
                for style in styles
            ]
            
            # –ñ–¥—ë–º –≤—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            results = await asyncio.gather(*tasks, return_exceptions=True)
            
            # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            images = []
            successful_count = 0
            
            for i, (result, style) in enumerate(zip(results, styles)):
                if isinstance(result, Exception):
                    logger.error(f"Generation {i+1} failed: {result}")
                    images.append({
                        "success": False,
                        "image_bytes": None,
                        "style_name": style["style_name"],
                        "prompt": style["prompt"],
                        "error": str(result)
                    })
                else:
                    images.append({
                        **result,
                        "style_name": style["style_name"],
                        "prompt": style["prompt"]
                    })
                    if result["success"]:
                        successful_count += 1
            
            logger.info(f"Photoshoot completed: {successful_count}/4 images generated successfully")
            
            # –£–≤–µ–¥–æ–º–ª—è–µ–º –∞–¥–º–∏–Ω–æ–≤ –µ—Å–ª–∏ –±—ã–ª–∏ –æ—à–∏–±–∫–∏
            if successful_count < 4:
                failed_styles = [
                    img["style_name"] 
                    for img in images 
                    if not img["success"]
                ]
                await NotificationService.notify_admins_processing_error(
                    bot=bot,
                    user_telegram_id=user.telegram_id,
                    username=user.username,
                    service_name="NanoBanana",
                    error_message=f"Failed to generate {4-successful_count} images: {', '.join(failed_styles)}"
                )
            
            return {
                "success": successful_count > 0,  # –£—Å–ø–µ—Ö –µ—Å–ª–∏ —Ö–æ—Ç—è –±—ã 1 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                "images": images,
                "successful_count": successful_count,
                "error": None if successful_count > 0 else "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–∏ –æ–¥–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è"
            }
            
        except Exception as e:
            logger.error(f"Critical error in generate_photoshoot: {e}", exc_info=True)
            
            # –£–≤–µ–¥–æ–º–ª—è–µ–º –∞–¥–º–∏–Ω–æ–≤
            await NotificationService.notify_admins_processing_error(
                bot=bot,
                user_telegram_id=user.telegram_id,
                username=user.username,
                service_name="ImageProcessor",
                error_message=str(e)
            )
            
            return {
                "success": False,
                "images": [],
                "successful_count": 0,
                "error": "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞. –ú—ã —É–∂–µ —Ä–∞–±–æ—Ç–∞–µ–º –Ω–∞–¥ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º."
            }
    
    async def _generate_single_variant(
        self,
        product_image_bytes: bytes,
        prompt: str,
        style_name: str,
        aspect_ratio: str
    ) -> Dict:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ–¥–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ"""
        try:
            logger.info(f"Generating '{style_name}' variant...")
            
            result = await self.nanobanana.generate_image(
                prompt=prompt,
                reference_image_bytes=product_image_bytes,
                aspect_ratio=aspect_ratio,
                strength=0.75  # –ë–∞–ª–∞–Ω—Å –º–µ–∂–¥—É –æ—Ä–∏–≥–∏–Ω–∞–ª–æ–º –∏ –ø—Ä–æ–º–ø—Ç–æ–º
            )
            
            return result
            
        except Exception as e:
            logger.error(f"Error generating '{style_name}': {e}")
            return {
                "success": False,
                "image_bytes": None,
                "error": str(e)
            }
    
    async def test_service(self) -> bool:
        """–¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ NanoBanana"""
        return await self.nanobanana.test_connection()
```

***

### 9. Keyboards (`app/keyboards/inline.py`) - üîÑ –î–û–ë–ê–í–ò–¢–¨ –Ω–æ–≤—ã–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã

**–ò—Å—Ç–æ—á–Ω–∏–∫:** [photo-portrait-bot/app/keyboards/](https://github.com/f2re/photo-portrait-bot/tree/main/app/keyboards)

**–î–µ–π—Å—Ç–≤–∏–µ:** –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ + –î–û–ë–ê–í–ò–¢–¨ –Ω–æ–≤—ã–µ

```python
"""
Inline –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
"""
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.utils.keyboard import InlineKeyboardBuilder
from typing import List, Dict
from app.config import settings

# ‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑ –∏—Å—Ö–æ–¥–Ω–∏–∫–∞

# ‚≠ê –î–û–ë–ê–í–ò–¢–¨ –Ω–æ–≤—ã–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã:

def get_aspect_ratio_keyboard() -> InlineKeyboardMarkup:
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –≤—ã–±–æ—Ä–∞ –ø—Ä–æ–ø–æ—Ä—Ü–∏–π"""
    builder = InlineKeyboardBuilder()
    
    ratios = {
        "1:1": "‚ñ° –ö–≤–∞–¥—Ä–∞—Ç (Instagram)",
        "3:4": "‚ñ≠ –í–µ—Ä—Ç–∏–∫–∞–ª—å (Stories)",
        "4:3": "‚ñ≠ –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å",
        "16:9": "‚ñ¨ –®–∏—Ä–æ–∫–∏–π (YouTube)",
        "9:16": "‚ñÆ –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π (TikTok)"
    }
    
    for ratio, label in ratios.items():
        builder.button(
            text=label,
            callback_data=f"aspect_ratio:{ratio}"
        )
    
    builder.adjust(1)  # –ü–æ 1 –∫–Ω–æ–ø–∫–µ –≤ —Ä—è–¥
    return builder.as_markup()


def get_style_selection_keyboard() -> InlineKeyboardMarkup:
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –≤—ã–±–æ—Ä–∞ –º–µ—Ç–æ–¥–∞ —Å—Ç–∏–ª–µ–π"""
    builder = InlineKeyboardBuilder()
    
    builder.button(
        text="üé® –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä",
        callback_data="styles:analyze"
    )
    builder.button(
        text="üé≤ –°–ª—É—á–∞–π–Ω—ã–µ —Å—Ç–∏–ª–∏",
        callback_data="styles:random"
    )
    builder.button(
        text="üìÅ –ú–æ–∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏",
        callback_data="styles:saved"
    )
    builder.button(
        text="üîô –ù–∞–∑–∞–¥",
        callback_data="back_to_ratio"
    )
    
    builder.adjust(1)
    return builder.as_markup()


def get_style_preview_keyboard(can_save: bool = True) -> InlineKeyboardMarkup:
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –ø–æ—Å–ª–µ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å—Ç–∏–ª–µ–π"""
    builder = InlineKeyboardBuilder()
    
    builder.button(
        text="‚úÖ –°–æ–∑–¥–∞—Ç—å —Ñ–æ—Ç–æ—Å–µ—Å—Å–∏—é",
        callback_data="confirm_generation"
    )
    builder.button(
        text="üîÑ –î—Ä—É–≥–∏–µ —Å–ª—É—á–∞–π–Ω—ã–µ —Å—Ç–∏–ª–∏",
        callback_data="styles:random"
    )
    
    if can_save:
        builder.button(
            text="üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —ç—Ç–æ—Ç —Å—Ç–∏–ª—å",
            callback_data="save_style"
        )
    
    builder.button(
        text="üîô –ù–∞–∑–∞–¥",
        callback_data="back_to_style_selection"
    )
    
    builder.adjust(1)
    return builder.as_markup()


def get_saved_styles_keyboard(styles: List[Dict]) -> InlineKeyboardMarkup:
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å–æ —Å–ø–∏—Å–∫–æ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —Å—Ç–∏–ª–µ–π"""
    builder = InlineKeyboardBuilder()
    
    for style in styles:
        # –ù–∞–∑–≤–∞–Ω–∏–µ + –ø—Ä–µ–≤—å—é —Ç–æ–≤–∞—Ä–∞ –∏ –ø—Ä–æ–ø–æ—Ä—Ü–∏–π
        text = f"{style['name']} ({style['aspect_ratio']})"
        builder.button(
            text=text,
            callback_data=f"apply_style:{style['id']}"
        )
    
    builder.button(
        text="üîô –ù–∞–∑–∞–¥",
        callback_data="back_to_style_selection"
    )
    
    builder.adjust(1)
    return builder.as_markup()


def get_style_management_keyboard(preset_id: int) -> InlineKeyboardMarkup:
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º —Å—Ç–∏–ª–µ–º"""
    builder = InlineKeyboardBuilder()
    
    builder.button(
        text="‚úèÔ∏è –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å",
        callback_data=f"rename_style:{preset_id}"
    )
    builder.button(
        text="üóë –£–¥–∞–ª–∏—Ç—å",
        callback_data=f"delete_style:{preset_id}"
    )
    builder.button(
        text="üîô –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É",
        callback_data="styles:saved"
    )
    
    builder.adjust(2, 1)
    return builder.as_markup()


def get_post_generation_keyboard(has_balance: bool) -> InlineKeyboardMarkup:
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –ø–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ñ–æ—Ç–æ—Å–µ—Å—Å–∏–∏"""
    builder = InlineKeyboardBuilder()
    
    if has_balance:
        builder.button(
            text="üé® –°–æ–∑–¥–∞—Ç—å –µ—â—ë —Ñ–æ—Ç–æ—Å–µ—Å—Å–∏—é",
            callback_data="new_photoshoot"
        )
    else:
        builder.button(
            text="üí≥ –ö—É–ø–∏—Ç—å –ø–∞–∫–µ—Ç",
            callback_data="buy_package"
        )
    
    builder.button(
        text="üìÅ –ú–æ–∏ —Å—Ç–∏–ª–∏",
        callback_data="manage_styles"
    )
    builder.button(
        text="‚ÑπÔ∏è –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å",
        callback_data="profile"
    )
    
    builder.adjust(1)
    return builder.as_markup()


def get_confirm_save_style_keyboard() -> InlineKeyboardMarkup:
    """–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ç–∏–ª—è"""
    builder = InlineKeyboardBuilder()
    
    builder.button(
        text="‚úÖ –î–∞, —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å",
        callback_data="confirm_save_style"
    )
    builder.button(
        text="‚ùå –û—Ç–º–µ–Ω–∞",
        callback_data="cancel_save_style"
    )
    
    builder.adjust(2)
    return builder.as_markup()
```

***

### 10. User Handler (`app/handlers/user.py`) - üîÑ –°–£–©–ï–°–¢–í–ï–ù–ù–ê–Ø –ú–û–î–ò–§–ò–ö–ê–¶–ò–Ø

**–ò—Å—Ç–æ—á–Ω–∏–∫:** [photo-portrait-bot/app/handlers/user.py](https://github.com/f2re/photo-portrait-bot/blob/main/app/handlers/user.py)

**–î–µ–π—Å—Ç–≤–∏–µ:** –ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–ª–æ—É –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–æ—Ç–æ

```python
"""
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
"""
import logging
from aiogram import Router, F, Bot
from aiogram.filters import Command, StateFilter
from aiogram.types import Message, CallbackQuery, InputMediaPhoto
from aiogram.fsm.context import FSMContext
from sqlalchemy.ext.asyncio import AsyncSession

from app.states import PhotoshootStates
from app.keyboards.inline import (
    get_aspect_ratio_keyboard,
    get_style_selection_keyboard,
    get_style_preview_keyboard,
    get_saved_styles_keyboard,
    get_post_generation_keyboard,
    get_confirm_save_style_keyboard
)
from app.services.prompt_generator import PromptGenerator
from app.services.image_processor import ImageProcessor
from app.services.style_manager import StyleManager
from app.database.crud import (
    get_or_create_user,
    update_user_images_count,
    create_processed_image
)
from app.config import settings

logger = logging.getLogger(__name__)
router = Router()

prompt_generator = PromptGenerator()
image_processor = ImageProcessor()

# ‚úÖ –°–ö–û–ü–ò–†–û–í–ê–¢–¨ /start handler –∏–∑ –∏—Å—Ö–æ–¥–Ω–∏–∫–∞ —Å –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–º–∏ —Ç–µ–∫—Å—Ç–∞–º–∏

@router.message(Command("start"))
async def cmd_start(message: Message, session: AsyncSession, state: FSMContext):
    """–ö–æ–º–∞–Ω–¥–∞ /start"""
    # ... (–ª–æ–≥–∏–∫–∞ –∏–∑ –∏—Å—Ö–æ–¥–Ω–∏–∫–∞, –∏–∑–º–µ–Ω–∏—Ç—å —Ç–µ–∫—Å—Ç—ã –Ω–∞ —Ç–æ–≤–∞—Ä–Ω—É—é —Ç–µ–º–∞—Ç–∏–∫—É)
    
    welcome_text = """
üé® <b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Product Photoshoot Bot!</b>

–Ø –ø–æ–º–æ–≥—É —Å–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—É—é —Ñ–æ—Ç–æ—Å–µ—Å—Å–∏—é –≤–∞—à–µ–≥–æ —Ç–æ–≤–∞—Ä–∞ –≤ —Ä–∞–∑–Ω—ã—Ö —Å—Ç–∏–ª—è—Ö! üì∏

<b>–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:</b>
1Ô∏è‚É£ –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ —Ç–æ–≤–∞—Ä–∞
2Ô∏è‚É£ –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
3Ô∏è‚É£ –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∏–ª–∏ —Å—ä–µ–º–∫–∏ (–∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ —Å–ª—É—á–∞–π–Ω—ã–µ!)
4Ô∏è‚É£ –ü–æ–ª—É—á–∏—Ç–µ 4 –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã—Ö —Ñ–æ—Ç–æ –≤ —Ä–∞–∑–Ω—ã—Ö —Å—Ç–∏–ª—è—Ö

–£ –≤–∞—Å –µ—Å—Ç—å <b>{free_count} –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö —Ñ–æ—Ç–æ—Å–µ—Å—Å–∏–π</b> –¥–ª—è –Ω–∞—á–∞–ª–∞! üéÅ

–ü—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ —Ç–æ–≤–∞—Ä–∞, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å! üì∑
"""
    
    # ... (–æ—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∏–∑ –∏—Å—Ö–æ–¥–Ω–∏–∫–∞)


@router.message(F.photo | F.document, StateFilter(None))
async def handle_product_photo(
    message: Message,
    session: AsyncSession,
    state: FSMContext,
    bot: Bot
):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ —Ñ–æ—Ç–æ —Ç–æ–≤–∞—Ä–∞"""
    try:
        # –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user = await get_or_create_user(
            session=session,
            telegram_id=message.from_user.id,
            username=message.from_user.username,
            first_name=message.from_user.first_name,
            last_name=message.from_user.last_name
        )
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–ª–∞–Ω—Å
        if user.images_remaining <= 0:
            await message.answer(
                "üòî –£ –≤–∞—Å –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å —Ñ–æ—Ç–æ—Å–µ—Å—Å–∏–∏!\n\n"
                "–ö—É–ø–∏—Ç–µ –ø–∞–∫–µ—Ç, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å:",
                reply_markup=get_buy_packages_keyboard()
            )
            return
        
        # –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–æ—Ç–æ
        if message.photo:
            file_id = message.photo[-1].file_id  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ
            file = await bot.get_file(file_id)
        else:  # document
            file_id = message.document.file_id
            file = await bot.get_file(file_id)
        
        # –ó–∞–≥—Ä—É–∂–∞–µ–º –±–∞–π—Ç—ã
        photo_bytes = await bot.download_file(file.file_path)
        photo_data = photo_bytes.read()
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        await state.update_data(
            product_image_bytes=photo_data,
            product_image_file_id=file_id
        )
        
        # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –≤—ã–±–æ—Ä—É –ø—Ä–æ–ø–æ—Ä—Ü–∏–π
        await message.answer(
            "‚úÖ –§–æ—Ç–æ —Ç–æ–≤–∞—Ä–∞ –ø–æ–ª—É—á–µ–Ω–æ!\n\n"
            "–¢–µ–ø–µ—Ä—å –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏ –¥–ª—è —Ñ–æ—Ç–æ—Å–µ—Å—Å–∏–∏:",
            reply_markup=get_aspect_ratio_keyboard()
        )
        
        await state.set_state(PhotoshootStates.selecting_aspect_ratio)
        
    except Exception as e:
        logger.error(f"Error handling product photo: {e}", exc_info=True)
        await message.answer(
            "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–æ—Ç–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞."
        )


@router.callback_query(F.data.startswith("aspect_ratio:"))
async def select_aspect_ratio(
    callback: CallbackQuery,
    state: FSMContext
):
    """–í—ã–±–æ—Ä –ø—Ä–æ–ø–æ—Ä—Ü–∏–π"""
    await callback.answer()
    
    aspect_ratio = callback.data.split(":")[1]
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º
    await state.update_data(aspect_ratio=aspect_ratio)
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ—Ç–æ–¥—ã –≤—ã–±–æ—Ä–∞ —Å—Ç–∏–ª—è
    await callback.message.edit_text(
        f"‚úÖ –í—ã–±—Ä–∞–Ω—ã –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏: <b>{aspect_ratio}</b>\n\n"
        "–¢–µ–ø–µ—Ä—å –≤—ã–±–µ—Ä–∏—Ç–µ, –∫–∞–∫ —Å–æ–∑–¥–∞—Ç—å —Å—Ç–∏–ª–∏ –¥–ª—è —Ñ–æ—Ç–æ—Å–µ—Å—Å–∏–∏:",
        reply_markup=get_style_selection_keyboard()
    )
    
    await state.set_state(PhotoshootStates.selecting_styles_method)


@router.callback_query(F.data == "styles:analyze")
async def analyze_product_styles(
    callback: CallbackQuery,
    state: FSMContext
):
    """–ê–Ω–∞–ª–∏–∑ —Ç–æ–≤–∞—Ä–∞ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö —Å—Ç–∏–ª–µ–π"""
    await callback.answer()
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å
    msg = await callback.message.edit_text(
        "üîç –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é —Ç–æ–≤–∞—Ä –∏ –ø–æ–¥–±–∏—Ä–∞—é –ø–æ–¥—Ö–æ–¥—è—â–∏–µ —Å—Ç–∏–ª–∏...\n\n"
        "‚è≥ –≠—Ç–æ –∑–∞–π–º—ë—Ç 10-15 —Å–µ–∫—É–Ω–¥"
    )
    
    # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    data = await state.get_data()
    aspect_ratio = data["aspect_ratio"]
    
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å—Ç–∏–ª–∏
    result = await prompt_generator.generate_styles_from_description(
        product_description="product from uploaded image",  # –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ
        aspect_ratio=aspect_ratio,
        random=False
    )
    
    if not result["success"]:
        await msg.edit_text(
            "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∏–ª–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Å–ª—É—á–∞–π–Ω—ã–µ —Å—Ç–∏–ª–∏.",
            reply_markup=get_style_selection_keyboard()
        )
        return
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∏–ª–∏ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    await state.update_data(
        product_name=result["product_name"],
        styles=result["styles"]
    )
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Å—Ç–∏–ª–µ–π
    styles_text = _format_styles_preview(result["styles"])
    
    await msg.edit_text(
        f"‚ú® <b>–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –≤–∞—à–µ–≥–æ —Ç–æ–≤–∞—Ä–∞:</b>\n\n"
        f"üì¶ –¢–æ–≤–∞—Ä: <b>{result['product_name']}</b>\n"
        f"üìê –ü—Ä–æ–ø–æ—Ä—Ü–∏–∏: <b>{aspect_ratio}</b>\n\n"
        f"{styles_text}\n\n"
        f"–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
        reply_markup=get_style_preview_keyboard(can_save=True)
    )
    
    await state.set_state(PhotoshootStates.reviewing_suggested_styles)


@router.callback_query(F.data == "styles:random")
async def generate_random_styles(
    callback: CallbackQuery,
    state: FSMContext
):
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω—ã—Ö –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã—Ö —Å—Ç–∏–ª–µ–π"""
    await callback.answer()
    
    msg = await callback.message.edit_text(
        "üé≤ –ì–µ–Ω–µ—Ä–∏—Ä—É—é —Å–ª—É—á–∞–π–Ω—ã–µ –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏—è...\n\n"
        "‚è≥ –≠—Ç–æ –∑–∞–π–º—ë—Ç 10-15 —Å–µ–∫—É–Ω–¥"
    )
    
    data = await state.get_data()
    aspect_ratio = data["aspect_ratio"]
    
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –°–õ–£–ß–ê–ô–ù–´–ï —Å—Ç–∏–ª–∏
    result = await prompt_generator.generate_styles_from_description(
        product_description="product from uploaded image",
        aspect_ratio=aspect_ratio,
        random=True  # ‚≠ê –°–ª—É—á–∞–π–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è
    )
    
    if not result["success"]:
        await msg.edit_text(
            "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∏–ª–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.",
            reply_markup=get_style_selection_keyboard()
        )
        return
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º
    await state.update_data(
        product_name=result["product_name"],
        styles=result["styles"]
    )
    
    styles_text = _format_styles_preview(result["styles"])
    
    await msg.edit_text(
        f"üé® <b>–°–ª—É—á–∞–π–Ω—ã–µ –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–µ —Å—Ç–∏–ª–∏:</b>\n\n"
        f"üì¶ –¢–æ–≤–∞—Ä: <b>{result['product_name']}</b>\n"
        f"üìê –ü—Ä–æ–ø–æ—Ä—Ü–∏–∏: <b>{aspect_ratio}</b>\n\n"
        f"{styles_text}\n\n"
        f"–ù–µ –ø–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å? –ú–æ–∂–µ—Ç–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –µ—â—ë —Ä–∞–∑! üé≤",
        reply_markup=get_style_preview_keyboard(can_save=True)
    )
    
    await state.set_state(PhotoshootStates.reviewing_suggested_styles)


@router.callback_query(F.data == "styles:saved")
async def show_saved_styles(
    callback: CallbackQuery,
    state: FSMContext,
    session: AsyncSession
):
    """–ü–æ–∫–∞–∑–∞—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏"""
    await callback.answer()
    
    user_id = callback.from_user.id
    
    # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∏–ª–∏ –∏–∑ –ë–î
    styles = await StyleManager.get_user_styles(session, user_id)
    
    if not styles:
        await callback.message.edit_text(
            "üìÅ –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —Å—Ç–∏–ª–µ–π.\n\n"
            "–°–æ–∑–¥–∞–π—Ç–µ —Ñ–æ—Ç–æ—Å–µ—Å—Å–∏—é –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–π—Å—è —Å—Ç–∏–ª—å!",
            reply_markup=get_style_selection_keyboard()
        )
        return
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫
    styles_list = "\n".join([
        f"{i+1}. <b>{s['name']}</b> ({s['aspect_ratio']}) - {s['product_name']}"
        for i, s in enumerate(styles)
    ])
    
    await callback.message.edit_text(
        f"üìÅ <b>–í–∞—à–∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ ({len(styles)}/{settings.MAX_SAVED_STYLES}):</b>\n\n"
        f"{styles_list}\n\n"
        f"–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∏–ª—å –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è:",
        reply_markup=get_saved_styles_keyboard(styles)
    )


@router.callback_query(F.data.startswith("apply_style:"))
async def apply_saved_style(
    callback: CallbackQuery,
    state: FSMContext,
    session: AsyncSession
):
    """–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π —Å—Ç–∏–ª—å"""
    await callback.answer()
    
    preset_id = int(callback.data.split(":")[1])
    user_id = callback.from_user.id
    
    # –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∏–ª—å –∏–∑ –ë–î
    style_data = await StyleManager.apply_style(session, user_id, preset_id)
    
    if not style_data:
        await callback.answer("‚ùå –°—Ç–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω", show_alert=True)
        return
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    await state.update_data(
        product_name=style_data["product_name"],
        aspect_ratio=style_data["aspect_ratio"],
        styles=style_data["styles"]
    )
    
    styles_text = _format_styles_preview(style_data["styles"])
    
    await callback.message.edit_text(
        f"‚úÖ <b>–ü—Ä–∏–º–µ–Ω—ë–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π —Å—Ç–∏–ª—å</b>\n\n"
        f"üì¶ –¢–æ–≤–∞—Ä: <b>{style_data['product_name']}</b>\n"
        f"üìê –ü—Ä–æ–ø–æ—Ä—Ü–∏–∏: <b>{style_data['aspect_ratio']}</b>\n\n"
        f"{styles_text}\n\n"
        f"–ì–æ—Ç–æ–≤—ã —Å–æ–∑–¥–∞—Ç—å —Ñ–æ—Ç–æ—Å–µ—Å—Å–∏—é?",
        reply_markup=get_style_preview_keyboard(can_save=False)  # –£–∂–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω
    )
    
    await state.set_state(PhotoshootStates.reviewing_suggested_styles)


@router.callback_query(F.data == "confirm_generation")
async def generate_photoshoot(
    callback: CallbackQuery,
    state: FSMContext,
    session: AsyncSession,
    bot: Bot
):
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ñ–æ—Ç–æ—Å–µ—Å—Å–∏–∏"""
    await callback.answer()
    
    # –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user = await get_or_create_user(
        session=session,
        telegram_id=callback.from_user.id,
        username=callback.from_user.username
    )
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–ª–∞–Ω—Å (1 —Ñ–æ—Ç–æ—Å–µ—Å—Å–∏—è = 4 —Ñ–æ—Ç–æ = 4 –∫—Ä–µ–¥–∏—Ç–∞ –∏–ª–∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–æ)
    photoshoots_cost = 1  # –ú–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å
    if user.images_remaining < photoshoots_cost:
        await callback.message.edit_text(
            "üòî –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ñ–æ—Ç–æ—Å–µ—Å—Å–∏–π –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏!\n\n"
            "–ö—É–ø–∏—Ç–µ –ø–∞–∫–µ—Ç:",
            reply_markup=get_buy_packages_keyboard()
        )
        return
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
    progress_msg = await callback.message.edit_text(
        "üé® –°–æ–∑–¥–∞—é –≤–∞—à—É —Ñ–æ—Ç–æ—Å–µ—Å—Å–∏—é...\n\n"
        "‚è≥ –ì–µ–Ω–µ—Ä–∏—Ä—É—é 4 –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã—Ö —Ñ–æ—Ç–æ\n"
        "–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 1-2 –º–∏–Ω—É—Ç—ã"
    )
    
    # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    data = await state.get_data()
    product_image_bytes = data["product_image_bytes"]
    styles = data["styles"]
    aspect_ratio = data["aspect_ratio"]
    product_name = data["product_name"]
    
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ñ–æ—Ç–æ—Å–µ—Å—Å–∏—é
    result = await image_processor.generate_photoshoot(
        product_image_bytes=product_image_bytes,
        styles=styles,
        aspect_ratio=aspect_ratio,
        bot=bot,
        user=user
    )
    
    if not result["success"] or result["successful_count"] == 0:
        await progress_msg.edit_text(
            f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ñ–æ—Ç–æ—Å–µ—Å—Å–∏—é.\n\n"
            f"–û—à–∏–±–∫–∞: {result.get('error', 'Unknown error')}\n\n"
            f"–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑ –∏–ª–∏ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π."
        )
        return
    
    # –°–ø–∏—Å—ã–≤–∞–µ–º –∫—Ä–µ–¥–∏—Ç—ã
    await update_user_images_count(session, user.id, -photoshoots_cost)
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ç–æ–∞–ª—å–±–æ–º
    media_group = []
    for i, img_data in enumerate(result["images"]):
        if img_data["success"]:
            # –°–æ–∑–¥–∞—ë–º InputMediaPhoto
            caption = f"<b>{img_data['style_name']}</b>" if i == 0 else None
            media_group.append(
                InputMediaPhoto(
                    media=img_data["image_bytes"],
                    caption=caption
                )
            )
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ë–î
            await create_processed_image(
                session=session,
                user_id=user.id,
                telegram_file_id=None,  # –ë—É–¥–µ—Ç –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏
                style_name=img_data["style_name"],
                prompt_used=img_data["prompt"],
                aspect_ratio=aspect_ratio
            )
    
    # –£–¥–∞–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
    await progress_msg.delete()
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∞–ª—å–±–æ–º
    if media_group:
        await callback.message.answer_media_group(media_group)
        
        await callback.message.answer(
            f"‚úÖ <b>–§–æ—Ç–æ—Å–µ—Å—Å–∏—è –≥–æ—Ç–æ–≤–∞!</b>\n\n"
            f"üì∏ –°–æ–∑–¥–∞–Ω–æ: {result['successful_count']}/4 —Ñ–æ—Ç–æ\n"
            f"üì¶ –¢–æ–≤–∞—Ä: {product_name}\n"
            f"üìê –ü—Ä–æ–ø–æ—Ä—Ü–∏–∏: {aspect_ratio}\n\n"
            f"üí∞ –û—Å—Ç–∞–ª–æ—Å—å —Ñ–æ—Ç–æ—Å–µ—Å—Å–∏–π: <b>{user.images_remaining - photoshoots_cost}</b>",
            reply_markup=get_post_generation_keyboard(
                has_balance=(user.images_remaining - photoshoots_cost) > 0
            )
        )
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ç–∏–ª—è
    await state.update_data(last_generated=True)
    await state.set_state(PhotoshootStates.generating_photoshoot)


@router.callback_query(F.data == "save_style")
async def initiate_save_style(
    callback: CallbackQuery,
    state: FSMContext,
    session: AsyncSession
):
    """–ù–∞—á–∞—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—Ç–∏–ª—è"""
    await callback.answer()
    
    user_id = callback.from_user.id
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç
    count = await StyleManager.get_user_styles(session, user_id)
    if len(count) >= settings.MAX_SAVED_STYLES:
        await callback.answer(
            f"‚ùå –î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —Å—Ç–∏–ª–µ–π ({settings.MAX_SAVED_STYLES})\n\n"
            "–£–¥–∞–ª–∏—Ç–µ —Å—Ç–∞—Ä—ã–π —Å—Ç–∏–ª—å, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–æ–≤—ã–π.",
            show_alert=True
        )
        return
    
    await callback.message.answer(
        "üíæ <b>–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—Ç–∏–ª—è</b>\n\n"
        "–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è —ç—Ç–æ–≥–æ —Å—Ç–∏–ª—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: \"–ú–∏–Ω–∏–º–∞–ª–∏–∑–º –±–µ–ª—ã–π —Ñ–æ–Ω\"):"
    )
    
    await state.set_state(PhotoshootStates.saving_style_name)


@router.message(StateFilter(PhotoshootStates.saving_style_name))
async def save_style_with_name(
    message: Message,
    state: FSMContext,
    session: AsyncSession
):
    """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—Ç–∏–ª—è —Å –∏–º–µ–Ω–µ–º"""
    style_name = message.text.strip()
    
    if len(style_name) > 100:
        await message.answer(
            "‚ùå –ù–∞–∑–≤–∞–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ (–º–∞–∫—Å. 100 —Å–∏–º–≤–æ–ª–æ–≤). –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∫–æ—Ä–æ—á–µ:"
        )
        return
    
    # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å—Ç–∏–ª—è
    data = await state.get_data()
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ë–î
    result = await StyleManager.save_style(
        session=session,
        user_id=message.from_user.id,
        name=style_name,
        product_name=data["product_name"],
        aspect_ratio=data["aspect_ratio"],
        styles=data["styles"]
    )
    
    if result["success"]:
        await message.answer(
            f"‚úÖ –°—Ç–∏–ª—å <b>\"{style_name}\"</b> —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω—ë–Ω!\n\n"
            f"–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–≥–æ —Å–Ω–æ–≤–∞ –≤ —Ä–∞–∑–¥–µ–ª–µ \"–ú–æ–∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏\".",
            reply_markup=get_post_generation_keyboard(has_balance=True)
        )
    else:
        await message.answer(
            f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç–∏–ª—å: {result['error']}"
        )
    
    await state.clear()


def _format_styles_preview(styles: list) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–µ–≤—å—é —Å—Ç–∏–ª–µ–π"""
    text = ""
    for i, style in enumerate(styles, 1):
        text += f"{i}. <b>{style['style_name']}</b>\n"
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ—Ä–æ—Ç–∫–æ–µ –ø—Ä–µ–≤—å—é –ø—Ä–æ–º–ø—Ç–∞
        prompt_preview = style['prompt'][:80] + "..." if len(style['prompt']) > 80 else style['prompt']
        text += f"   <i>{prompt_preview}</i>\n\n"
    return text

# ‚úÖ –°–ö–û–ü–ò–†–û–í–ê–¢–¨ –æ—Å—Ç–∞–ª—å–Ω—ã–µ handlers –∏–∑ –∏—Å—Ö–æ–¥–Ω–∏–∫–∞ (–ø—Ä–æ—Ñ–∏–ª—å, –ø–æ–º–æ—â—å, –∏ —Ç.–¥.)
```

***

### 11. Style Management Handler (`app/handlers/style_management.py`) - ‚≠ê –ù–û–í–´–ô

```python
"""
–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–º–∏ —Å—Ç–∏–ª—è–º–∏
"""
import logging
from aiogram import Router, F
from aiogram.types import CallbackQuery, Message
from aiogram.fsm.context import FSMContext
from aiogram.filters import StateFilter
from sqlalchemy.ext.asyncio import AsyncSession

from app.states import StyleManagementStates
from app.services.style_manager import StyleManager
from app.keyboards.inline import get_style_management_keyboard, get_saved_styles_keyboard
from app.config import settings

logger = logging.getLogger(__name__)
router = Router()

@router.callback_query(F.data == "manage_styles")
async def show_style_management(
    callback: CallbackQuery,
    session: AsyncSession
):
    """–ü–æ–∫–∞–∑–∞—Ç—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∏–ª—è–º–∏"""
    await callback.answer()
    
    user_id = callback.from_user.id
    styles = await StyleManager.get_user_styles(session, user_id)
    
    if not styles:
        await callback.message.edit_text(
            "üìÅ –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —Å—Ç–∏–ª–µ–π.\n\n"
            "–°–æ–∑–¥–∞–π—Ç–µ —Ñ–æ—Ç–æ—Å–µ—Å—Å–∏—é –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–π—Å—è —Å—Ç–∏–ª—å!"
        )
        return
    
    styles_list = ""
    for i, s in enumerate(styles, 1):
        styles_list += (
            f"{i}. <b>{s['name']}</b>\n"
            f"   üì¶ {s['product_name']} | üìê {s['aspect_ratio']}\n"
            f"   üìÖ {s['created_at'].strftime('%d.%m.%Y')}\n\n"
        )
    
    await callback.message.edit_text(
        f"üìÅ <b>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∏–ª—è–º–∏ ({len(styles)}/{settings.MAX_SAVED_STYLES})</b>\n\n"
        f"{styles_list}"
        "–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∏–ª—å:",
        reply_markup=get_saved_styles_keyboard(styles)
    )


@router.callback_query(F.data.startswith("delete_style:"))
async def delete_style(
    callback: CallbackQuery,
    session: AsyncSession
):
    """–£–¥–∞–ª–∏—Ç—å —Å—Ç–∏–ª—å"""
    preset_id = int(callback.data.split(":")[1])
    user_id = callback.from_user.id
    
    success = await StyleManager.delete_style(session, user_id, preset_id)
    
    if success:
        await callback.answer("‚úÖ –°—Ç–∏–ª—å —É–¥–∞–ª—ë–Ω", show_alert=True)
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
        await show_style_management(callback, session)
    else:
        await callback.answer("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å—Ç–∏–ª—å", show_alert=True)


@router.callback_query(F.data.startswith("rename_style:"))
async def initiate_rename_style(
    callback: CallbackQuery,
    state: FSMContext
):
    """–ù–∞—á–∞—Ç—å –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ"""
    await callback.answer()
    
    preset_id = int(callback.data.split(":")[1])
    
    await state.update_data(renaming_preset_id=preset_id)
    await state.set_state(StyleManagementStates.editing_style_name)
    
    await callback.message.answer(
        "‚úèÔ∏è –í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è —Å—Ç–∏–ª—è:"
    )


@router.message(StateFilter(StyleManagementStates.editing_style_name))
async def rename_style_confirm(
    message: Message,
    state: FSMContext,
    session: AsyncSession
):
    """–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è"""
    new_name = message.text.strip()
    
    if len(new_name) > 100:
        await message.answer(
            "‚ùå –ù–∞–∑–≤–∞–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ (–º–∞–∫—Å. 100 —Å–∏–º–≤–æ–ª–æ–≤)"
        )
        return
    
    data = await state.get_data()
    preset_id = data["renaming_preset_id"]
    
    success = await StyleManager.rename_style(
        session,
        message.from_user.id,
        preset_id,
        new_name
    )
    
    if success:
        await message.answer(f"‚úÖ –°—Ç–∏–ª—å –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω –≤ <b>\"{new_name}\"</b>")
    else:
        await message.answer("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å —Å—Ç–∏–ª—å")
    
    await state.clear()
```

***

### 12. Requirements.txt - üîÑ –î–û–ë–ê–í–ò–¢–¨ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

```txt
# –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ (–∏–∑ –∏—Å—Ö–æ–¥–Ω–∏–∫–∞)
asyncpg
aiogram==3.4.1
sqlalchemy==2.0.25
asyncpg==0.29.0
alembic==1.13.1
aiohttp==3.9.1
python-dotenv==1.0.0
pillow==10.2.0
pydantic==2.5.3
pydantic-settings==2.1.0
redis==5.0.1
numpy==1.26.3
scikit-learn==1.3.2
yookassa==3.0.0
```

–í—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ —É–∂–µ –ø–æ–∫—Ä—ã—Ç–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏!

***

### 13. .env.example - üîÑ –û–ë–ù–û–í–ò–¢–¨

```env
# Telegram Bot
BOT_TOKEN=your_telegram_bot_token
BOT_USERNAME=your_bot_username
ADMIN_IDS=123456789,987654321

# Database
DATABASE_URL=postgresql+asyncpg://product_user:password@localhost:5432/product_photoshoot_bot
# OR use individual components:
DB_HOST=localhost
DB_PORT=5432
DB_NAME=product_photoshoot_bot
DB_USER=product_user
DB_PASSWORD=your_password

# OpenRouter API (–¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Ä–æ–º–ø—Ç–æ–≤ —á–µ—Ä–µ–∑ Claude)
OPENROUTER_API_KEY=your_openrouter_api_key
PROMPT_MODEL=anthropic/claude-3.5-sonnet

# YooKassa Payments
YOOKASSA_SHOP_ID=your_shop_id
YOOKASSA_SECRET_KEY=your_secret_key
YOOKASSA_RETURN_URL=https://t.me/your_product_bot

# Packages Configuration
PACKAGE_1_NAME=–°—Ç–∞—Ä—Ç–æ–≤—ã–π
PACKAGE_1_PHOTOSHOOTS=3
PACKAGE_1_PRICE=299

PACKAGE_2_NAME=–ë–∏–∑–Ω–µ—Å
PACKAGE_2_PHOTOSHOOTS=10
PACKAGE_2_PRICE=799

PACKAGE_3_NAME=–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π
PACKAGE_3_PHOTOSHOOTS=30
PACKAGE_3_PRICE=1999

PACKAGE_4_NAME=–ë–µ–∑–ª–∏–º–∏—Ç–Ω—ã–π
PACKAGE_4_PHOTOSHOOTS=100
PACKAGE_4_PRICE=4999

# Settings
FREE_PHOTOSHOOTS_COUNT=2
PHOTOS_PER_PHOTOSHOOT=4
MAX_SAVED_STYLES=4
LOG_LEVEL=INFO

# Yandex Metrika (optional)
YANDEX_METRIKA_COUNTER_ID=
YANDEX_METRIKA_TOKEN=
METRIKA_GOAL_START=start_bot
METRIKA_GOAL_FIRST_PHOTOSHOOT=first_photoshoot
METRIKA_GOAL_PURCHASE=purchase
METRIKA_UPLOAD_INTERVAL=3600

# Referral Program
REFERRAL_REWARD_START=1
REFERRAL_REWARD_PURCHASE_PERCENT=10
```

***

## –ò—Ç–æ–≥–æ–≤—ã–π User Flow

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ñ–æ—Ç–æ —Ç–æ–≤–∞—Ä–∞
   ‚Üì
2. –ë–æ—Ç –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –≤—ã–±—Ä–∞—Ç—å –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏ (1:1, 3:4, 4:3, 16:9, 9:16)
   ‚Üì
3. –í—ã–±–æ—Ä –º–µ—Ç–æ–¥–∞ —Å—Ç–∏–ª–µ–π:
   a) üé® –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä ‚Üí Claude –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç 4 –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö —Å—Ç–∏–ª—è
   b) üé≤ –°–ª—É—á–∞–π–Ω—ã–µ —Å—Ç–∏–ª–∏ ‚Üí Claude –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç 4 –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã—Ö —Å–ª—É—á–∞–π–Ω—ã—Ö —Å—Ç–∏–ª—è
   c) üìÅ –ú–æ–∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ ‚Üí –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ä–∞–Ω–µ–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π —Å—Ç–∏–ª—å
   ‚Üì
4. –ü—Ä–µ–≤—å—é —Å—Ç–∏–ª–µ–π:
   - –ü–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è 4 —Å—Ç–∏–ª—è —Å –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏ –∏ –ø—Ä–æ–º–ø—Ç–∞–º–∏
   - –ú–æ–∂–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –¥—Ä—É–≥–∏–µ —Å–ª—É—á–∞–π–Ω—ã–µ (üîÑ)
   - –ú–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —ç—Ç–æ—Ç –Ω–∞–±–æ—Ä (üíæ)
   ‚Üì
5. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ ‚Üí ‚úÖ –°–æ–∑–¥–∞—Ç—å —Ñ–æ—Ç–æ—Å–µ—Å—Å–∏—é
   ‚Üì
6. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è:
   - 4 –∑–∞–ø—Ä–æ—Å–∞ –≤ NanoBanana API –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
   - –ö–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å: reference_image + unique_prompt + aspect_ratio
   ‚Üì
7. –†–µ–∑—É–ª—å—Ç–∞—Ç:
   - –§–æ—Ç–æ–∞–ª—å–±–æ–º –∏–∑ 4 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
   - –ü–æ–¥–ø–∏—Å–∏ —Å–æ —Å—Ç–∏–ª—è–º–∏
   - –°–ø–∏—Å–∞–Ω–∏–µ 1 —Ñ–æ—Ç–æ—Å–µ—Å—Å–∏–∏ (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–æ)
   ‚Üì
8. Post-generation:
   - üé® –°–æ–∑–¥–∞—Ç—å –µ—â—ë
   - üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç–∏–ª—å (–µ—Å–ª–∏ –µ—â—ë –Ω–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω)
   - üìÅ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∏–ª—è–º–∏
```

***
